const STATUS_CODE = require('../constants/status-codes');
const {
  ERROR_MONGO_CAST_ERROR,
  ERROR_MONGO_DUPLICATE_FIELD,
  ERROR_MONGO_VALIDATION_ERROR,
} = require('../constants/mongo-errors');
const {
  JWT_TOKEN_ERROR,
  JWT_TOKEN_EXPIRED_ERROR,
} = require('../constants/jwt-errors');
const AppError = require('../utils/app-error');

const DEFAULT_ERROR_STATUS_CODE = 500;

const handleMongoCaseError = (err) => {
  const message = `Invalid ${err.path}: ${err.value}`;
  return new AppError(message, STATUS_CODE.BadRequest);
};

const handleMongoValidationError = (err) => {
  const errors = Object.values(err.errors).map((item) => item.message);
  const message = `Invalid input data. ${errors.join('. ')}`;
  return new AppError(message, STATUS_CODE.BadRequest);
};

const handleMongoDuplicateFieldError = (err) => {
  const message = `Duplicate field value: ${err.keyValue.name}. Please use another value.`;
  return new AppError(message, STATUS_CODE.BadRequest);
};

const handleJWTInvalidSignatureError = () =>
  new AppError('Invalid token. Please login again', STATUS_CODE.Unauthorized);

const handleJWTTokenExpiredError = () =>
  new AppError('Token expired. Please login again', STATUS_CODE.Unauthorized);

const sendDevelopmentError = (err, res) => {
  console.log(err);
  const { statusCode = DEFAULT_ERROR_STATUS_CODE } = err;

  res.status(statusCode).json({
    ok: false,
    error: { message: err.message, stack: err.stack, error: err },
  });
};

const sendProductionError = (err, res) => {
  const { statusCode = DEFAULT_ERROR_STATUS_CODE } = err;

  // Operational errors (generated by server)
  if (err.isOperational) {
    res.status(statusCode).json({
      ok: false,
      error: { message: err.message },
    });
    return;
  }

  console.error(`ðŸ”´ ERROR: ${JSON.stringify(err)}`);

  // programming errors
  res.status(STATUS_CODE.InternalServerError).json({
    ok: false,
    error: { message: 'Something went wrong!.' },
  });
};

module.exports = (err, req, res, next) => {
  if (process.env.NODE_ENV === 'development') {
    sendDevelopmentError(err, res);
    return;
  }

  let error = { ...err, name: err.name };

  if (error.name === ERROR_MONGO_CAST_ERROR) {
    error = handleMongoCaseError(error);
  }

  if (error.name === ERROR_MONGO_VALIDATION_ERROR) {
    error = handleMongoValidationError(error);
  }

  // JWT errors
  if (error.name === JWT_TOKEN_ERROR) {
    error = handleJWTInvalidSignatureError(error);
  }

  if (error.name === JWT_TOKEN_EXPIRED_ERROR) {
    error = handleJWTTokenExpiredError(error);
  }

  if (error.code === ERROR_MONGO_DUPLICATE_FIELD) {
    error = handleMongoDuplicateFieldError(error);
  }

  sendProductionError(error, res);
};
